local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local FlyModule = {
    enabled = false,
    speed = 25,
    connection = nil,
    CONTROL = {F = 0, B = 0, L = 0, R = 0, UP = 0, DOWN = 0},
}

-- Create GUI
local function createFlyGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FlyGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 150, 0, 120)
    mainFrame.Position = UDim2.new(0.5, -75, 0.5, -60)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 2
    mainFrame.BorderColor3 = Color3.fromRGB(100, 150, 255)
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 25)
    title.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    title.BorderSizePixel = 0
    title.Text = "FLY CONTROL"
    title.TextColor3 = Color3.fromRGB(100, 200, 255)
    title.TextSize = 14
    title.Font = Enum.Font.GothamBold
    title.Parent = mainFrame

    -- Toggle Fly Button
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleFly"
    toggleBtn.Size = UDim2.new(0.9, 0, 0, 28)
    toggleBtn.Position = UDim2.new(0.05, 0, 0, 30)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    toggleBtn.BorderSizePixel = 1
    toggleBtn.BorderColor3 = Color3.fromRGB(100, 100, 255)
    toggleBtn.Text = "START"
    toggleBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    toggleBtn.TextSize = 12
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Parent = mainFrame

    -- Speed Label
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Size = UDim2.new(0.5, 0, 0, 20)
    speedLabel.Position = UDim2.new(0.05, 0, 0, 63)
    speedLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    speedLabel.BorderSizePixel = 0
    speedLabel.Text = "Speed: 25"
    speedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    speedLabel.TextSize = 11
    speedLabel.Font = Enum.Font.Gotham
    speedLabel.Parent = mainFrame

    -- Speed Slider
    local speedSlider = Instance.new("TextButton")
    speedSlider.Size = UDim2.new(0.4, 0, 0, 20)
    speedSlider.Position = UDim2.new(0.55, 0, 0, 63)
    speedSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    speedSlider.BorderSizePixel = 1
    speedSlider.BorderColor3 = Color3.fromRGB(100, 150, 255)
    speedSlider.Text = "+/-"
    speedSlider.TextColor3 = Color3.fromRGB(200, 200, 200)
    speedSlider.TextSize = 10
    speedSlider.Font = Enum.Font.Gotham
    speedSlider.Parent = mainFrame

    -- Speed Up Button
    local speedUpBtn = Instance.new("TextButton")
    speedUpBtn.Size = UDim2.new(0.4, 0, 0, 18)
    speedUpBtn.Position = UDim2.new(0.05, 0, 0, 88)
    speedUpBtn.BackgroundColor3 = Color3.fromRGB(50, 70, 50)
    speedUpBtn.BorderSizePixel = 1
    speedUpBtn.BorderColor3 = Color3.fromRGB(100, 200, 100)
    speedUpBtn.Text = "Speed +"
    speedUpBtn.TextColor3 = Color3.fromRGB(100, 255, 100)
    speedUpBtn.TextSize = 10
    speedUpBtn.Font = Enum.Font.GothamBold
    speedUpBtn.Parent = mainFrame

    -- Speed Down Button
    local speedDownBtn = Instance.new("TextButton")
    speedDownBtn.Size = UDim2.new(0.4, 0, 0, 18)
    speedDownBtn.Position = UDim2.new(0.55, 0, 0, 88)
    speedDownBtn.BackgroundColor3 = Color3.fromRGB(70, 50, 50)
    speedDownBtn.BorderSizePixel = 1
    speedDownBtn.BorderColor3 = Color3.fromRGB(200, 100, 100)
    speedDownBtn.Text = "Speed -"
    speedDownBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
    speedDownBtn.TextSize = 10
    speedDownBtn.Font = Enum.Font.GothamBold
    speedDownBtn.Parent = mainFrame

    return {
        gui = screenGui,
        toggleBtn = toggleBtn,
        speedLabel = speedLabel,
        speedUpBtn = speedUpBtn,
        speedDownBtn = speedDownBtn,
    }
end

-- Fly Functions
local function startFly()
    if FlyModule.enabled then return end
    
    FlyModule.enabled = true
    
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not hrp or not hum then return end
    
    if FlyModule.connection then FlyModule.connection:Disconnect() end
    
    FlyModule.connection = RunService.RenderStepped:Connect(function()
        if not FlyModule.enabled then return end
        
        local char = player.Character
        if not char then 
            FlyModule.enabled = false 
            return 
        end
        
        local hrp = char:FindFirstChild("HumanoidRootPart")
        local hum = char:FindFirstChild("Humanoid")
        if not hrp or not hum then 
            FlyModule.enabled = false 
            return 
        end
        
        local cam = workspace.CurrentCamera
        local moveVelocity = Vector3.new(0, 0, 0)
        
        if FlyModule.CONTROL.L + FlyModule.CONTROL.R ~= 0 or FlyModule.CONTROL.F + FlyModule.CONTROL.B ~= 0 then
            moveVelocity = ((cam.CFrame.LookVector * (FlyModule.CONTROL.F + FlyModule.CONTROL.B)) + 
                           (cam.CFrame.RightVector * (FlyModule.CONTROL.L + FlyModule.CONTROL.R))).Unit * FlyModule.speed
        end
        
        if FlyModule.CONTROL.UP == 1 then
            moveVelocity = moveVelocity + Vector3.new(0, FlyModule.speed, 0)
        elseif FlyModule.CONTROL.DOWN == 1 then
            moveVelocity = moveVelocity - Vector3.new(0, FlyModule.speed, 0)
        end
        
        hrp.AssemblyLinearVelocity = moveVelocity
        hum:ChangeState(Enum.HumanoidStateType.Flying)
    end)
end

local function stopFly()
    if not FlyModule.enabled then return end
    
    FlyModule.enabled = false
    
    if FlyModule.connection then
        FlyModule.connection:Disconnect()
        FlyModule.connection = nil
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum:ChangeState(Enum.HumanoidStateType.Running)
        end
    end
end

-- Initialize
local guiElements = createFlyGUI()

-- Toggle Button Click
guiElements.toggleBtn.MouseButton1Click:Connect(function()
    if FlyModule.enabled then
        stopFly()
        guiElements.toggleBtn.Text = "START"
        guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    else
        startFly()
        guiElements.toggleBtn.Text = "STOP"
        guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 50)
    end
end)

-- Speed Up Button
guiElements.speedUpBtn.MouseButton1Click:Connect(function()
    FlyModule.speed = math.min(FlyModule.speed + 5, 100)
    guiElements.speedLabel.Text = "Speed: " .. FlyModule.speed
end)

-- Speed Down Button
guiElements.speedDownBtn.MouseButton1Click:Connect(function()
    FlyModule.speed = math.max(FlyModule.speed - 5, 5)
    guiElements.speedLabel.Text = "Speed: " .. FlyModule.speed
end)

-- Keyboard Controls
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.W then
        FlyModule.CONTROL.F = 1
    elseif input.KeyCode == Enum.KeyCode.S then
        FlyModule.CONTROL.B = -1
    elseif input.KeyCode == Enum.KeyCode.A then
        FlyModule.CONTROL.L = -1
    elseif input.KeyCode == Enum.KeyCode.D then
        FlyModule.CONTROL.R = 1
    elseif input.KeyCode == Enum.KeyCode.Space then
        FlyModule.CONTROL.UP = 1
    elseif input.KeyCode == Enum.KeyCode.LeftControl then
        FlyModule.CONTROL.DOWN = 1
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.W then
        FlyModule.CONTROL.F = 0
    elseif input.KeyCode == Enum.KeyCode.S then
        FlyModule.CONTROL.B = 0
    elseif input.KeyCode == Enum.KeyCode.A then
        FlyModule.CONTROL.L = 0
    elseif input.KeyCode == Enum.KeyCode.D then
        FlyModule.CONTROL.R = 0
    elseif input.KeyCode == Enum.KeyCode.Space then
        FlyModule.CONTROL.UP = 0
    elseif input.KeyCode == Enum.KeyCode.LeftControl then
        FlyModule.CONTROL.DOWN = 0
    end
end)

-- Stop fly on character respawn
player.CharacterAdded:Connect(function()
    if FlyModule.enabled then 
        stopFly()
        guiElements.toggleBtn.Text = "START"
        guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    end
end)
