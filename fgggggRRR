local Module = {}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local PathfindingService = game:GetService("PathfindingService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

Module.commonAnimals = {"Noobini Pizzanini", "Lirilì Larilà"}
Module.adminAnimals = {"Strawberry Elephant", "Admin Lucky Block", "Los Lucky Blocks"}
Module.brainrotGodAnimals = {
    "Chihuanini Taconini", "Cocofanto Elefanto", "Tralalero Tralala", "Odin Din Din Dun",
    "Girafa Celestre", "Trenostruzzo Turbo 3000", "Matteo", "Tigroligre Frutonni",
    "Orcalero Orcala", "Unclito Samito", "Gattatino Nyanino", "Espresso Signora",
    "Ballerino Lololo", "Piccione Macchina", "Los Crocodillitos", "Tukanno Bananno",
    "Trippi Troppi Troppa Trippa", "Los Tungtungtungcitos", "Agarrini la Palini",
    "Bulbito Bandito Traktorito", "Los Orcalitos", "Tipi Topi Taco", "Bombardini Tortinii",
    "Tralalita Tralala", "Urubini Flamenguini", "Alessio", "Pakrahmatmamat",
    "Los Bombinitos", "Brr es Teh Patipum", "Tartaruga Cisterna", "Cacasito Satalito",
    "Mastodontico Telepiedone", "Crabbo Limonetta", "Gattito Tacoto", "Los Tipi Tacos",
    "Antonio", "Las Capuchinas", "Orcalita Orcala", "Piccionetta Macchina",
    "Anpali Babel", "Extinct Ballerina", "Tractoro Dinosauro", "Belula Beluga",
    "Capi Taco", "Dug dug dug", "Corn Corn Corn Sahur", "Brasilini Berimbini",
    "Squalanana", "Pop Pop Sahur", "Vampira Cappucina", "Jacko Jack Jack",
    "Snailenzo", "Tentacolo Tecnico"
}

Module.secretAnimals = {
    "La Vacca Saturno Saturnita", "Los Tralaleritos", "Graipuss Medussi", "La Grande Combinasion",
    "Sammyni Spyderini", "Garama and Madundung", "Torrtuginni Dragonfrutini", "Las Tralaleritas",
    "Pot Hotspot", "Nuclearo Dinossauro", "Las Vaquitas Saturnitas", "Chicleteira Bicicleteira",
    "Agarrini la Palini", "Los Combinasionas", "Karkerkar Kurkur", "Dragon Cannelloni",
    "Los Hotspotsitos", "Esok Sekolah", "Nooo My Hotspot", "Los Matteos", "Job Job Job Sahur",
    "Dul Dul Dul", "Blackhole Goat", "Los Spyderinis", "Ketupat Kepat", "La Supreme Combinasion",
    "Bisonte Giuppitere", "Guerriro Digitale", "Ketchuru and Musturu", "Spaghetti Tualetti",
    "Los Nooo My Hotspotsitos", "Trenostruzzo Turbo 4000", "Fragola La La La", "La Sahur Combinasion",
    "La Karkerkar Combinasion", "Tralaledon", "Los Bros", "Los Chicleteiras", "Chachechi",
    "Extinct Tralalero", "Extinct Matteo", "67", "Las Sis", "Celularcini Viciosini",
    "La Extinct Grande", "Quesadilla Crocodila", "Tacorita Bicicleta", "La Cucaracha",
    "To to to Sahur", "Mariachi Corazoni", "Los Tacoritas", "Tictac Sahur", "Yess my examine",
    "Karker Sahur", "Noo my examine", "Money Money Puggy", "Los Primos", "Tang Tang Keletang",
    "Perrito Burrito", "Chillin Chili", "Los Tortus", "Los Karkeritos", "Los Jobcitos", "Los 67",
    "La Secret Combinasion", "Burguro And Fryuro", "Zombie Tralala", "Vulturino Skeletono",
    "Frankentteo", "La Vacca Jacko Linterino", "Chicleteirina Bicicleteirina", "Eviledon",
    "La Spooky Grande", "Los Mobilis", "Spooky and Pumpky"
}

Module.animalColors = {
    ["Noobini Pizzanini"] = Color3.fromRGB(200, 200, 200),
    ["Lirilì Larilà"] = Color3.fromRGB(200, 200, 200),
    ["Strawberry Elephant"] = Color3.fromRGB(0, 255, 255),
    ["Admin Lucky Block"] = Color3.fromRGB(0, 255, 255),
    ["Los Lucky Blocks"] = Color3.fromRGB(0, 255, 255)
}
Module.secretColor = Color3.fromRGB(255, 0, 255)

function Module.InitAntiAFK()
    task.spawn(function()
        while true do
            task.wait(30)
            pcall(function()
                local mouse = player:GetMouse()
                mouse.Move = mouse.Move + Vector2.new(math.random(-50, 50), math.random(-50, 50))
            end)
        end
    end)

    task.spawn(function()
        while true do
            task.wait(45)
            pcall(function()
                local keys = {Enum.KeyCode.W, Enum.KeyCode.A, Enum.KeyCode.S, Enum.KeyCode.D, Enum.KeyCode.Space}
                local key = keys[math.random(#keys)]
                UserInputService:SendKeyEvent(true, key, false)
                task.wait(0.1)
                UserInputService:SendKeyEvent(false, key, false)
            end)
        end
    end)

    task.spawn(function()
        while true do
            task.wait(60)
            pcall(function()
                local char = player.Character
                if char then
                    local humanoid = char:FindFirstChild("Humanoid")
                    local root = char:FindFirstChild("HumanoidRootPart")
                    if humanoid and root then
                        local dir = {Vector3.new(1,0,0), Vector3.new(-1,0,0), Vector3.new(0,0,1), Vector3.new(0,0,-1)}
                        humanoid:MoveTo(root.Position + dir[math.random(#dir)] * 5)
                    end
                end
            end)
        end
    end)

    task.spawn(function()
        while true do
            task.wait(35)
            pcall(function()
                local char = player.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    Camera.CFrame = Camera.CFrame * CFrame.Angles(0, math.rad(math.random(-30, 30)), 0)
                end
            end)
        end
    end)
end

function Module.GetAnimalInfo(model)
    local success, info = pcall(function()
        local overhead = model:FindFirstChild("Part") and model.Part:FindFirstChild("Info") and model.Part.Info:FindFirstChild("AnimalOverhead")
        if not overhead then return nil end
        return {
            Name = overhead:FindFirstChild("DisplayName") and overhead.DisplayName.Text or "?"
        }
    end)
    return success and info or nil
end

function Module.GetProximityPrompt(model)
    local promptAttachment = model:FindFirstChild("Part") and model.Part:FindFirstChild("PromptAttachment")
    if promptAttachment then
        return promptAttachment:FindFirstChild("ProximityPrompt")
    end
    return nil
end

function Module.HoldProximityPrompt(prompt, holdTime)
    if not prompt then return false end
    
    local success = pcall(function()
        prompt:InputHoldBegin()
        task.wait(holdTime + 0.1)
        prompt:InputHoldEnd()
    end)
    
    return success
end

function Module.SetupProximityDetection(callback)
    local StarterGui = game:GetService("StarterGui")
    local RunService = game:GetService("RunService")
    
    local recent = {}
    local DEBOUNCE_TIME = 0.25
    
    local function onPromptTriggered(prompt)
        if recent[prompt] then return end
        recent[prompt] = true
        
        task.delay(DEBOUNCE_TIME, function()
            recent[prompt] = nil
        end)
        
        if callback then
            callback(prompt)
        end
    end
    
    local function connectPrompt(prompt)
        if not prompt or not prompt:IsA("ProximityPrompt") then return end
        
        pcall(function()
            prompt.Triggered:Connect(function()
                onPromptTriggered(prompt)
            end)
        end)
    end
    
    for _, prompt in ipairs(workspace:GetDescendants()) do
        if prompt:IsA("ProximityPrompt") then
            connectPrompt(prompt)
        end
    end
    
    workspace.DescendantAdded:Connect(function(desc)
        if desc:IsA("ProximityPrompt") then
            task.wait()
            connectPrompt(desc)
        end
    end)
end

-- Smart pathfinding that adapts based on location
function Module.IsInPlot(position, plotController)
    if not plotController then return false end
    
    local myPlot = plotController:GetMyPlot()
    if not myPlot or not myPlot.PlotModel then return false end
    
    local plotId = myPlot.PlotModel.Name
    local plot = workspace.Plots:FindFirstChild(plotId)
    
    if not plot then return false end
    
    -- Check if position is within plot bounds
    local plotRegion = plot:FindFirstChild("PlotRegion") or plot
    if plotRegion and plotRegion:IsA("BasePart") then
        local plotPos = plotRegion.Position
        local plotSize = plotRegion.Size
        local halfSize = plotSize / 2
        
        local isWithinX = math.abs(position.X - plotPos.X) <= halfSize.X
        local isWithinY = math.abs(position.Y - plotPos.Y) <= halfSize.Y
        local isWithinZ = math.abs(position.Z - plotPos.Z) <= halfSize.Z
        
        return isWithinX and isWithinY and isWithinZ
    end
    
    -- Fallback: check distance from plot
    local distance = (position - plot:GetPivot().Position).Magnitude
    return distance <= 50
end

function Module.WalkToTarget(character, targetPos, plotController)
    local root = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    
    if not root or not humanoid then return end

    local inPlot = Module.IsInPlot(root.Position, plotController)
    
    if inPlot then
        -- Use pathfinding when in plot to avoid obstacles
        local path = PathfindingService:CreatePath({
            AgentRadius = 2,
            AgentHeight = 5,
            AgentCanJump = true,
            AgentCanClimb = false,
            WaypointSpacing = 4
        })
        
        path:ComputeAsync(root.Position, targetPos)

        if path.Status ~= Enum.PathStatus.Success then
            humanoid:MoveTo(targetPos)
            task.wait(5)
            return
        end

        local waypoints = path:GetWaypoints()
        
        for i = 1, #waypoints do
            if not character.Parent then break end
            
            local wp = waypoints[i]
            humanoid:MoveTo(wp.Position)
            
            local timeout = 0
            while (root.Position - wp.Position).Magnitude > 4 and character.Parent do
                task.wait(0.1)
                timeout = timeout + 0.1
                if timeout > 3 then break end
            end
        end
    else
        -- Direct movement when outside plot
        humanoid:MoveTo(targetPos)
        
        local timeout = 0
        while (root.Position - targetPos).Magnitude > 5 and character.Parent and timeout < 10 do
            task.wait(0.1)
            timeout = timeout + 0.1
        end
    end
    
    task.wait(0.5)
end

function Module.CreateTracer(name)
    local line = Drawing.new("Line")
    line.Visible = false
    line.Color = Color3.fromRGB(255, 0, 0)
    line.Thickness = 3
    line.Transparency = 0.7
    return line
end

function Module.CreateBillboard(name, parent)
    local billboard = Instance.new("BillboardGui")
    billboard.Adornee = parent
    billboard.Size = UDim2.new(0, 100, 0, 25)
    billboard.AlwaysOnTop = true
    billboard.StudsOffset = Vector3.new(0, 2, 0)

    local text = Instance.new("TextLabel", billboard)
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.TextColor3 = Module.animalColors[name] or Module.secretColor
    text.Text = name
    text.TextStrokeTransparency = 0.5
    text.Font = Enum.Font.SourceSansBold
    text.TextSize = 12
    text.TextScaled = true

    billboard.Parent = game.CoreGui
    return billboard
end

function Module.CreateHighlights(name, model)
    local highlights = {}
    
    for _, child in pairs(model:GetChildren()) do
        if child:IsA("Model") and child.Name ~= "Part" then
            for _, part in pairs(child:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = part
                    highlight.FillColor = Module.animalColors[name] or Module.secretColor
                    highlight.OutlineColor = Module.animalColors[name] or Module.secretColor
                    highlight.FillTransparency = 0.5
                    highlight.OutlineTransparency = 0
                    highlight.Parent = game.CoreGui
                    table.insert(highlights, highlight)
                end
            end
        end
    end
    
    if #highlights == 0 then
        for _, part in pairs(model:GetDescendants()) do
            if part:IsA("BasePart") or part:IsA("MeshPart") then
                local highlight = Instance.new("Highlight")
                highlight.Adornee = part
                highlight.FillColor = Module.animalColors[name] or Module.secretColor
                highlight.OutlineColor = Module.animalColors[name] or Module.secretColor
                highlight.FillTransparency = 0.5
                highlight.OutlineTransparency = 0
                highlight.Parent = game.CoreGui
                table.insert(highlights, highlight)
            end
        end
    end
    
    return highlights
end

function Module.CleanupESP(esp)
    if esp.Billboard then esp.Billboard:Destroy() end
    if esp.Tracer then esp.Tracer:Remove() end
    if esp.Highlights then
        for _, highlight in pairs(esp.Highlights) do
            highlight:Destroy()
        end
    end
end

return Module
