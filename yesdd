local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local FlyModule = {
    enabled = false,
    speed = 25,
    connection = nil,
    CONTROL = {F = 0, B = 0, L = 0, R = 0, UP = 0, DOWN = 0},
}

local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- Create Mobile Controls GUI
local function createMobileControlsGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MobileControlsGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    -- Main Fly Button (Top Center)
    local flyButton = Instance.new("TextButton")
    flyButton.Name = "FlyButton"
    flyButton.Size = UDim2.new(0, 80, 0, 80)
    flyButton.Position = UDim2.new(0.5, -40, 0, 20)
    flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    flyButton.BorderSizePixel = 2
    flyButton.BorderColor3 = Color3.fromRGB(100, 150, 255)
    flyButton.Text = "FLY"
    flyButton.TextColor3 = Color3.fromRGB(100, 200, 255)
    flyButton.TextSize = 20
    flyButton.Font = Enum.Font.GothamBold
    flyButton.Parent = screenGui

    -- D-Pad Container (Bottom Left)
    local dpadContainer = Instance.new("Frame")
    dpadContainer.Name = "DPadContainer"
    dpadContainer.Size = UDim2.new(0, 160, 0, 160)
    dpadContainer.Position = UDim2.new(0, 10, 1, -170)
    dpadContainer.BackgroundTransparency = 1
    dpadContainer.Parent = screenGui

    -- Up Button
    local upBtn = Instance.new("TextButton")
    upBtn.Name = "Up"
    upBtn.Size = UDim2.new(0, 50, 0, 50)
    upBtn.Position = UDim2.new(0.35, 0, 0, 0)
    upBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    upBtn.BorderSizePixel = 1
    upBtn.BorderColor3 = Color3.fromRGB(100, 200, 255)
    upBtn.Text = "↑"
    upBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    upBtn.TextSize = 24
    upBtn.Parent = dpadContainer

    -- Down Button
    local downBtn = Instance.new("TextButton")
    downBtn.Name = "Down"
    downBtn.Size = UDim2.new(0, 50, 0, 50)
    downBtn.Position = UDim2.new(0.35, 0, 0, 110)
    downBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    downBtn.BorderSizePixel = 1
    downBtn.BorderColor3 = Color3.fromRGB(100, 200, 255)
    downBtn.Text = "↓"
    downBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    downBtn.TextSize = 24
    downBtn.Parent = dpadContainer

    -- Left Button
    local leftBtn = Instance.new("TextButton")
    leftBtn.Name = "Left"
    leftBtn.Size = UDim2.new(0, 50, 0, 50)
    leftBtn.Position = UDim2.new(0, 0, 0.35, 0)
    leftBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    leftBtn.BorderSizePixel = 1
    leftBtn.BorderColor3 = Color3.fromRGB(100, 200, 255)
    leftBtn.Text = "←"
    leftBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    leftBtn.TextSize = 24
    leftBtn.Parent = dpadContainer

    -- Right Button
    local rightBtn = Instance.new("TextButton")
    rightBtn.Name = "Right"
    rightBtn.Size = UDim2.new(0, 50, 0, 50)
    rightBtn.Position = UDim2.new(0.7, 0, 0.35, 0)
    rightBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    rightBtn.BorderSizePixel = 1
    rightBtn.BorderColor3 = Color3.fromRGB(100, 200, 255)
    rightBtn.Text = "→"
    rightBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    rightBtn.TextSize = 24
    rightBtn.Parent = dpadContainer

    -- Vertical Controls (Bottom Right)
    local verticalContainer = Instance.new("Frame")
    verticalContainer.Name = "VerticalContainer"
    verticalContainer.Size = UDim2.new(0, 110, 0, 110)
    verticalContainer.Position = UDim2.new(1, -120, 1, -120)
    verticalContainer.BackgroundTransparency = 1
    verticalContainer.Parent = screenGui

    -- Rise Button
    local riseBtn = Instance.new("TextButton")
    riseBtn.Name = "Rise"
    riseBtn.Size = UDim2.new(1, 0, 0, 50)
    riseBtn.Position = UDim2.new(0, 0, 0, 0)
    riseBtn.BackgroundColor3 = Color3.fromRGB(50, 70, 50)
    riseBtn.BorderSizePixel = 1
    riseBtn.BorderColor3 = Color3.fromRGB(100, 200, 100)
    riseBtn.Text = "RISE"
    riseBtn.TextColor3 = Color3.fromRGB(100, 255, 100)
    riseBtn.TextSize = 14
    riseBtn.Font = Enum.Font.GothamBold
    riseBtn.Parent = verticalContainer

    -- Fall Button
    local fallBtn = Instance.new("TextButton")
    fallBtn.Name = "Fall"
    fallBtn.Size = UDim2.new(1, 0, 0, 50)
    fallBtn.Position = UDim2.new(0, 0, 0, 60)
    fallBtn.BackgroundColor3 = Color3.fromRGB(70, 50, 50)
    fallBtn.BorderSizePixel = 1
    fallBtn.BorderColor3 = Color3.fromRGB(200, 100, 100)
    fallBtn.Text = "FALL"
    fallBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
    fallBtn.TextSize = 14
    fallBtn.Font = Enum.Font.GothamBold
    fallBtn.Parent = verticalContainer

    return {
        gui = screenGui,
        flyButton = flyButton,
        upBtn = upBtn,
        downBtn = downBtn,
        leftBtn = leftBtn,
        rightBtn = rightBtn,
        riseBtn = riseBtn,
        fallBtn = fallBtn,
    }
end

-- Create PC Keyboard GUI
local function createPCGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PCFlyGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 100, 0, 60)
    mainFrame.Position = UDim2.new(0.5, -50, 0.5, -30)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 2
    mainFrame.BorderColor3 = Color3.fromRGB(100, 150, 255)
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleFly"
    toggleBtn.Size = UDim2.new(0.9, 0, 1, -5)
    toggleBtn.Position = UDim2.new(0.05, 0, 0, 5)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    toggleBtn.BorderSizePixel = 1
    toggleBtn.BorderColor3 = Color3.fromRGB(100, 100, 255)
    toggleBtn.Text = "FLY"
    toggleBtn.TextColor3 = Color3.fromRGB(100, 200, 255)
    toggleBtn.TextSize = 18
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Parent = mainFrame

    return {
        gui = screenGui,
        toggleBtn = toggleBtn,
    }
end

-- Fly Functions
local function startFly()
    if FlyModule.enabled then return end
    FlyModule.enabled = true
    
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not hrp or not hum then return end
    
    if FlyModule.connection then FlyModule.connection:Disconnect() end
    
    FlyModule.connection = RunService.RenderStepped:Connect(function()
        if not FlyModule.enabled then return end
        
        local char = player.Character
        if not char then 
            FlyModule.enabled = false 
            return 
        end
        
        local hrp = char:FindFirstChild("HumanoidRootPart")
        local hum = char:FindFirstChild("Humanoid")
        if not hrp or not hum then 
            FlyModule.enabled = false 
            return 
        end
        
        local cam = workspace.CurrentCamera
        local moveVelocity = Vector3.new(0, 0, 0)
        
        if FlyModule.CONTROL.L + FlyModule.CONTROL.R ~= 0 or FlyModule.CONTROL.F + FlyModule.CONTROL.B ~= 0 then
            moveVelocity = ((cam.CFrame.LookVector * (FlyModule.CONTROL.F + FlyModule.CONTROL.B)) + 
                           (cam.CFrame.RightVector * (FlyModule.CONTROL.L + FlyModule.CONTROL.R))).Unit * FlyModule.speed
        end
        
        if FlyModule.CONTROL.UP == 1 then
            moveVelocity = moveVelocity + Vector3.new(0, FlyModule.speed, 0)
        elseif FlyModule.CONTROL.DOWN == 1 then
            moveVelocity = moveVelocity - Vector3.new(0, FlyModule.speed, 0)
        end
        
        hrp.AssemblyLinearVelocity = moveVelocity
        hum:ChangeState(Enum.HumanoidStateType.Flying)
    end)
end

local function stopFly()
    if not FlyModule.enabled then return end
    FlyModule.enabled = false
    
    if FlyModule.connection then
        FlyModule.connection:Disconnect()
        FlyModule.connection = nil
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum:ChangeState(Enum.HumanoidStateType.Running)
        end
    end
end

-- Button Press/Release Functions
local function buttonPressed(control)
    FlyModule.CONTROL[control] = (control == "F" and 1) or (control == "B" and -1) or (control == "L" and -1) or (control == "R" and 1) or (control == "UP" and 1) or (control == "DOWN" and 1) or 0
end

local function buttonReleased(control)
    FlyModule.CONTROL[control] = 0
end

-- Initialize
local guiElements
if isMobile then
    guiElements = createMobileControlsGUI()
else
    guiElements = createPCGUI()
end

-- Fly Button
if isMobile then
    guiElements.flyButton.MouseButton1Click:Connect(function()
        if FlyModule.enabled then
            stopFly()
            guiElements.flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        else
            startFly()
            guiElements.flyButton.BackgroundColor3 = Color3.fromRGB(50, 100, 50)
        end
    end)

    -- Mobile Button Controls
    guiElements.upBtn.MouseButton1Down:Connect(function() buttonPressed("F") end)
    guiElements.upBtn.MouseButton1Up:Connect(function() buttonReleased("F") end)
    guiElements.upBtn.TouchBegan:Connect(function() buttonPressed("F") end)
    guiElements.upBtn.TouchEnded:Connect(function() buttonReleased("F") end)

    guiElements.downBtn.MouseButton1Down:Connect(function() buttonPressed("B") end)
    guiElements.downBtn.MouseButton1Up:Connect(function() buttonReleased("B") end)
    guiElements.downBtn.TouchBegan:Connect(function() buttonPressed("B") end)
    guiElements.downBtn.TouchEnded:Connect(function() buttonReleased("B") end)

    guiElements.leftBtn.MouseButton1Down:Connect(function() buttonPressed("L") end)
    guiElements.leftBtn.MouseButton1Up:Connect(function() buttonReleased("L") end)
    guiElements.leftBtn.TouchBegan:Connect(function() buttonPressed("L") end)
    guiElements.leftBtn.TouchEnded:Connect(function() buttonReleased("L") end)

    guiElements.rightBtn.MouseButton1Down:Connect(function() buttonPressed("R") end)
    guiElements.rightBtn.MouseButton1Up:Connect(function() buttonReleased("R") end)
    guiElements.rightBtn.TouchBegan:Connect(function() buttonPressed("R") end)
    guiElements.rightBtn.TouchEnded:Connect(function() buttonReleased("R") end)

    guiElements.riseBtn.MouseButton1Down:Connect(function() buttonPressed("UP") end)
    guiElements.riseBtn.MouseButton1Up:Connect(function() buttonReleased("UP") end)
    guiElements.riseBtn.TouchBegan:Connect(function() buttonPressed("UP") end)
    guiElements.riseBtn.TouchEnded:Connect(function() buttonReleased("UP") end)

    guiElements.fallBtn.MouseButton1Down:Connect(function() buttonPressed("DOWN") end)
    guiElements.fallBtn.MouseButton1Up:Connect(function() buttonReleased("DOWN") end)
    guiElements.fallBtn.TouchBegan:Connect(function() buttonPressed("DOWN") end)
    guiElements.fallBtn.TouchEnded:Connect(function() buttonReleased("DOWN") end)
else
    -- PC Controls
    guiElements.toggleBtn.MouseButton1Click:Connect(function()
        if FlyModule.enabled then
            stopFly()
            guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        else
            startFly()
            guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 50)
        end
    end)

    -- Keyboard Controls
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.W then FlyModule.CONTROL.F = 1
        elseif input.KeyCode == Enum.KeyCode.S then FlyModule.CONTROL.B = -1
        elseif input.KeyCode == Enum.KeyCode.A then FlyModule.CONTROL.L = -1
        elseif input.KeyCode == Enum.KeyCode.D then FlyModule.CONTROL.R = 1
        elseif input.KeyCode == Enum.KeyCode.Space then FlyModule.CONTROL.UP = 1
        elseif input.KeyCode == Enum.KeyCode.LeftControl then FlyModule.CONTROL.DOWN = 1
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.W then FlyModule.CONTROL.F = 0
        elseif input.KeyCode == Enum.KeyCode.S then FlyModule.CONTROL.B = 0
        elseif input.KeyCode == Enum.KeyCode.A then FlyModule.CONTROL.L = 0
        elseif input.KeyCode == Enum.KeyCode.D then FlyModule.CONTROL.R = 0
        elseif input.KeyCode == Enum.KeyCode.Space then FlyModule.CONTROL.UP = 0
        elseif input.KeyCode == Enum.KeyCode.LeftControl then FlyModule.CONTROL.DOWN = 0
        end
    end)
end

-- Character Respawn
player.CharacterAdded:Connect(function()
    if FlyModule.enabled then 
        stopFly()
        if guiElements.flyButton then
            guiElements.flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        elseif guiElements.toggleBtn then
            guiElements.toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        end
    end
end)
